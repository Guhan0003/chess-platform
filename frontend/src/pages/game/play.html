<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0a0a0a">
  <meta name="description" content="Chess Platform - Play online chess games with advanced AI">
  
  <title>Game - Chess Platform</title>
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ôõ</text></svg>">
  
  <!-- Fonts - Preload for better performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Stylesheets -->
  <link rel="stylesheet" href="../../styles/global.css">
  <link rel="stylesheet" href="play.css">
</head>
<body>
  <div id="app">
    <div class="game-container fade-in">
      <!-- Game Header -->
      <header class="game-header">
        <div class="game-title">
          <span class="game-id" id="gameId">Game #---</span>
          <div class="game-status-badge" id="gameStatus">Loading...</div>
        </div>
        
        <div class="current-user-info" id="currentUserInfo" style="display: none;">
          <span>Playing as: </span>
          <strong id="currentUserName">---</strong>
          <span>(</span><span id="currentUserRating">----</span><span>)</span>
        </div>
        
        <div class="game-actions">
          <a href="#" class="back-btn" data-route="/lobby">
            <span>‚Üê</span>
            <span>Back to Lobby</span>
          </a>
        </div>
      </header>

      <!-- Game Content -->
      <div class="game-content">
        <!-- Player Info -->
        <div class="players-section">
          <div class="player-card white" id="whitePlayer">
            <div class="player-avatar">
              <span id="whiteAvatar">?</span>
            </div>
            <div class="player-info">
              <div class="player-name" id="whiteName">Loading...</div>
              <div class="player-rating">
                Rating: <span class="rating-badge" id="whiteRating">----</span>
              </div>
            </div>
            <div class="player-timer" id="whiteTimer">‚àû</div>
          </div>

          <div class="player-card black" id="blackPlayer">
            <div class="player-avatar black">
              <span id="blackAvatar">?</span>
            </div>
            <div class="player-info">
              <div class="player-name" id="blackName">Waiting...</div>
              <div class="player-rating">
                Rating: <span class="rating-badge" id="blackRating">----</span>
              </div>
            </div>
            <div class="player-timer" id="blackTimer">‚àû</div>
          </div>
        </div>

        <!-- Chess Board -->
        <div class="board-container">
          <div class="chess-board" id="chessBoard">
            <!-- Board squares will be generated here -->
            <div class="loading-overlay" id="boardLoading">
              <div class="loading-spinner"></div>
            </div>
          </div>
        </div>

        <!-- Game Sidebar -->
        <div class="game-sidebar">
          <!-- Game Controls -->
          <div class="sidebar-panel">
            <div class="panel-header">
              <h3 class="panel-title">
                <span>‚öôÔ∏è</span>
                Game Controls
              </h3>
            </div>
            <div class="panel-content">
              <div class="game-controls">
                <div class="control-group">
                  <button class="control-btn" id="offerDrawBtn">
                    ü§ù Offer Draw
                  </button>
                  <button class="control-btn danger" id="resignBtn">
                    üè≥Ô∏è Resign
                  </button>
                </div>
                <div class="control-group">
                  <button class="control-btn" id="flipBoardBtn">
                    üîÑ Flip Board
                  </button>
                  <button class="control-btn" id="analysisBtn">
                    üìä Analysis
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Move History -->
          <div class="sidebar-panel">
            <div class="panel-header">
              <h3 class="panel-title">
                <span>üìú</span>
                Move History
              </h3>
            </div>
            <div class="panel-content">
              <div class="move-history" id="moveHistory">
                <div class="move-list" id="moveList">
                  <!-- Moves will be populated here -->
                  <div style="text-align: center; color: var(--color-text-muted); font-size: var(--font-size-sm);">
                    No moves yet. Game starting...
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Game Status -->
          <div class="sidebar-panel">
            <div class="panel-header">
              <h3 class="panel-title">
                <span>üìã</span>
                Game Info
              </h3>
            </div>
            <div class="panel-content">
              <div class="game-status">
                <div class="status-message" id="statusMessage">Game in progress</div>
                <div class="status-details" id="statusDetails">White to move</div>
              </div>
            </div>
          </div>

          <!-- Captured Pieces -->
          <div class="sidebar-panel">
            <div class="panel-header">
              <h3 class="panel-title">
                <span>üè¥‚Äç‚ò†Ô∏è</span>
                Captured Pieces
              </h3>
            </div>
            <div class="panel-content">
              <div class="captured-pieces" id="capturedPieces">
                <!-- Captured pieces will be shown here -->
                <div style="text-align: center; color: var(--color-text-muted); font-size: var(--font-size-sm);">
                  No captures yet
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Promotion Dialog -->
      <div class="promotion-dialog" id="promotionDialog">
        <div class="promotion-content">
          <h3 class="promotion-title">Choose promotion piece:</h3>
          <div class="promotion-pieces">
            <div class="promotion-piece" data-piece="q">‚ôï</div>
            <div class="promotion-piece" data-piece="r">‚ôñ</div>
            <div class="promotion-piece" data-piece="b">‚ôó</div>
            <div class="promotion-piece" data-piece="n">‚ôò</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Game Result Modal -->
  <div class="modal-overlay" id="gameResultModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="gameResultTitle">Game Finished</h2>
      </div>
      <div class="modal-body">
        <div class="result-info">
          <div class="result-message" id="gameResultMessage"></div>
          <div class="result-details" id="gameResultDetails"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="newGameBtn">New Game</button>
        <button class="btn btn-secondary" id="backToLobbyBtn">Back to Lobby</button>
      </div>
    </div>
  </div>

  <!-- Error Toast -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Scripts - Load utilities first, then page script -->
  <script>
    // Initialize global variables for game page
    window.gamePageReady = false;
    window.gamePageData = {};
    
    // Error handling for missing dependencies
    window.addEventListener('error', function(e) {
      console.error('Game page error:', e.error);
    });
  </script>
  <script src="../../utils/api.js"></script>
  <script src="../../utils/router.js"></script>
  <script src="../../utils/websocket.js"></script>
  <script src="play.js"></script>
  
  <!-- Initialize page after all scripts load -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Game page DOM loaded, initializing...');
      
      // Ensure all dependencies are loaded
      if (typeof ChessAPI !== 'undefined') {
        // Initialize the game page
        if (typeof initializeGamePage === 'function') {
          initializeGamePage();
          window.gamePageReady = true;
          console.log('Game page initialized successfully');
        } else {
          console.error('initializeGamePage function not found');
        }
      } else {
        console.error('Required dependencies not loaded');
      }
    });
  </script>
</body>
</html>